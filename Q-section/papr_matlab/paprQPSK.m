clc;
clear;

%ccdf = comm.CCDF('AveragePowerOutputPort',true,'PeakPowerOutputPort',true);
block=4000;
Q = 8;
symbolcount = 2;
sccount = 512/symbolcount;

for i = 1: block
    message = randi([0 1],512,1);
    A = 100;
    for p = 1:2^Q
        messagenew = message;
        messagenew(1:Q) = xor(messagenew(1:Q),de2bi(p-1,Q)');
        messagenew = nrPolarEncode(messagenew,1024,10,false);
        qamTxSig = qammod(messagenew,4,'InputType','bit','UnitAveragePower',true);
        for sym = 1:symbolcount
            TTT = ifft(qamTxSig(sccount*(sym-1)+1:sccount*(sym-1)+sccount));
            G(sym) = 10*log10(max(abs(TTT).^2)/mean(abs(TTT).^2));
        end
        
        if max(G) < max(A)
           A = G; 
        end
        
    end
    B((i-1)*symbolcount+1:(i-1)*symbolcount+symbolcount) = A;
end

for j = 1:29
   C(j) = length(B(B>2.75+0.25*j)) ;
end

D = [3:0.25:10];
test = C/(block*symbolcount);
plot(D,log10(C/(block*symbolcount)));

%Q=12,32sym:
%[0.991593750000000,0.982343750000000,0.950656250000000,0.913812500000000,0.843031250000000,0.788406250000000,0.733937500000000,0.668750000000000,0.555156250000000,0.445937500000000,0.390812500000000,0.308375000000000,0.253500000000000,0.201468750000000,0.144625000000000,0.100531250000000,0.0696562500000000,0.0473750000000000,0.0337500000000000,0.0217812500000000,0.0132500000000000,0.00731250000000000,0.00471875000000000,0.00287500000000000,0.00196875000000000,0.00112500000000000,0.000625000000000000,0.000218750000000000,9.37500000000000e-05]

%Q=8,32sym:
%[0.991687500000000,0.980187500000000,0.948312500000000,0.911062500000000,0.839593750000000,0.786125000000000,0.734375000000000,0.668468750000000,0.555093750000000,0.447781250000000,0.393437500000000,0.306093750000000,0.252937500000000,0.200625000000000,0.143187500000000,0.102593750000000,0.0705312500000000,0.0488125000000000,0.0342187500000000,0.0221250000000000,0.0129375000000000,0.00709375000000000,0.00493750000000000,0.00275000000000000,0.00184375000000000,0.00106250000000000,0.000531250000000000,0.000218750000000000,9.37500000000000e-05]

%Q=8,16sym:
%[0.999937500000000,0.999687500000000,0.998187500000000,0.994062500000000,0.984812500000000,0.968062500000000,0.937187500000000,0.898625000000000,0.831937500000000,0.743875000000000,0.664750000000000,0.571125000000000,0.479000000000000,0.379312500000000,0.291312500000000,0.216875000000000,0.160250000000000,0.117937500000000,0.0791875000000000,0.0552500000000000,0.0356875000000000,0.0222500000000000,0.0141875000000000,0.00912500000000000,0.00575000000000000,0.00362500000000000,0.00256250000000000,0.00156250000000000,0.00100000000000000]

%Q=8,8sym:
%[1,1,1,1,0.999875000000000,0.999500000000000,0.997000000000000,0.991125000000000,0.974750000000000,0.942250000000000,0.895750000000000,0.828000000000000,0.744250000000000,0.626250000000000,0.520000000000000,0.410125000000000,0.319375000000000,0.237875000000000,0.168500000000000,0.116250000000000,0.0781250000000000,0.0543750000000000,0.0353750000000000,0.0216250000000000,0.0143750000000000,0.00875000000000000,0.00487500000000000,0.00250000000000000,0.00162500000000000]

%Q=8,4sym:
%[1,1,1,1,1,1,1,0.999875000000000,0.999625000000000,0.997875000000000,0.990000000000000,0.973625000000000,0.938875000000000,0.874750000000000,0.784625000000000,0.682125000000000,0.557875000000000,0.438000000000000,0.325000000000000,0.236625000000000,0.167375000000000,0.114500000000000,0.0767500000000000,0.0532500000000000,0.0347500000000000,0.0210000000000000,0.0138750000000000,0.00612500000000000,0.00362500000000000]

%Q=8,2sym:




